<div class="chat-header d-flex align-items-center border-bottom pb-2 mb-3">
    <img src="{{ url_for('static', filename='uploads/' ~ other_user.profile_pic) }}" alt="Profile Picture" class="chat-user-pic">
    <h5>{{ other_user.username }}</h5>
</div>
<div class="chat-container">
    <div class="chat-messages" id="chat-messages">
        {% for msg in conversation %}
        <div class="message-container {% if msg.sender_id == current_user.id %}sent-message{% else %}received-message{% endif %}">
            <div class="message-content">
                <p>{{ msg.content }}</p>
                <span class="message-time">{{ msg.created_at.strftime('%b %d, %Y %I:%M %p') }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="message-input-container">
        <form id="message-form" action="{{ url_for('send_message', user_id=other_user.id) }}" method="POST">
            <input type="text" name="message_content" placeholder="Type a message..." required>
            <button type="submit">Send</button>
        </form>
    </div>
</div>

<link rel="stylesheet" href="{{ url_for('static', filename='css/chat_box.css') }}">
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const messageForm = document.getElementById('message-form');
        const chatMessages = document.getElementById('chat-messages');

        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();

            fetch(this.action, {
                method: 'POST',
                body: new FormData(this),
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }

                const messageDiv = document.createElement('div');
                messageDiv.className = 'message-container sent-message';
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <p>${data.content}</p>
                        <span class="message-time">${data.timestamp}</span>
                    </div>
                `;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                messageForm.reset();
            })
            .catch(error => {
                console.error('Error sending message:', error);
            });
        });
    });
</script>
